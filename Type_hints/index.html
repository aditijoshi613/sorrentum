<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Type hints - My Docs</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Welcome to MkDocs</a>
                            </li>
                            <li class="navitem">
                                <a href="../Buildmeister_process/" class="nav-link">Buildmeister process</a>
                            </li>
                            <li class="navitem">
                                <a href="../Code_review/" class="nav-link">Code review</a>
                            </li>
                            <li class="navitem">
                                <a href="../Codebase_clean_up_scripts/" class="nav-link">Codebase clean-up scripts</a>
                            </li>
                            <li class="navitem">
                                <a href="../Coding_Style_Guide/" class="nav-link">Sorrentum - Python Style Guide</a>
                            </li>
                            <li class="navitem">
                                <a href="../Contributor_Scorecard/" class="nav-link">Contributor Scorecard</a>
                            </li>
                            <li class="navitem">
                                <a href="../DataFlow/" class="nav-link">DataFlow specification</a>
                            </li>
                            <li class="navitem">
                                <a href="../DataPull/" class="nav-link">DataPull</a>
                            </li>
                            <li class="navitem">
                                <a href="../Design_Philosophy/" class="nav-link">Design Philosophy</a>
                            </li>
                            <li class="navitem">
                                <a href="../Development_workflow/" class="nav-link">Development Workflow</a>
                            </li>
                            <li class="navitem">
                                <a href="../Docker/" class="nav-link">Docker</a>
                            </li>
                            <li class="navitem">
                                <a href="../Documentation_about_guidelines/" class="nav-link">Documentation about guidelines</a>
                            </li>
                            <li class="navitem">
                                <a href="../Email/" class="nav-link">Email</a>
                            </li>
                            <li class="navitem">
                                <a href="../First_review_process/" class="nav-link">First Review Process</a>
                            </li>
                            <li class="navitem">
                                <a href="../From_zero_to_modeling/" class="nav-link">From zero to modeling</a>
                            </li>
                            <li class="navitem">
                                <a href="../General_rules_of_collaboration/" class="nav-link">General Rules of Collaboration</a>
                            </li>
                            <li class="navitem">
                                <a href="../GitHub_ZenHub_workflows/" class="nav-link">GitHub/ZenHub workflows</a>
                            </li>
                            <li class="navitem">
                                <a href="../Git_workflow_and_best_practices/" class="nav-link">Git workflow and best practices</a>
                            </li>
                            <li class="navitem">
                                <a href="../Glossary/" class="nav-link">Glossary</a>
                            </li>
                            <li class="navitem">
                                <a href="../Gsheet_into_pandas/" class="nav-link">Gsheet into pandas</a>
                            </li>
                            <li class="navitem">
                                <a href="../HTMLcov_server/" class="nav-link">HTMLcov server</a>
                            </li>
                            <li class="navitem">
                                <a href="../How_to_integrate_repos/" class="nav-link">How to integrate repos</a>
                            </li>
                            <li class="navitem">
                                <a href="../How_to_organize_your_work/" class="nav-link">Golden rules</a>
                            </li>
                            <li class="navitem">
                                <a href="../Imports_and_packages/" class="nav-link">Imports and packages</a>
                            </li>
                            <li class="navitem">
                                <a href="../Jupyter_notebook_best_practices/" class="nav-link">Jupyter notebook best practices</a>
                            </li>
                            <li class="navitem">
                                <a href="../Reading_List/" class="nav-link">Reading List</a>
                            </li>
                            <li class="navitem">
                                <a href="../Receive_crypto_payment/" class="nav-link">Receive crypto payment</a>
                            </li>
                            <li class="navitem">
                                <a href="../Scrum_methodology/" class="nav-link">Scrum Methodology</a>
                            </li>
                            <li class="navitem">
                                <a href="../Signing_up_for_Sorrentum/" class="nav-link">Signing up to the project</a>
                            </li>
                            <li class="navitem">
                                <a href="../Sorrentum_development_setup/" class="nav-link">Sorrentum development setup</a>
                            </li>
                            <li class="navitem">
                                <a href="../Telegram/" class="nav-link">Telegram</a>
                            </li>
                            <li class="navitem">
                                <a href="../Tools-PyCharm/" class="nav-link">Running PyCharm remotely</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">Type hints</a>
                            </li>
                            <li class="navitem">
                                <a href="../Unit_tests/" class="nav-link">Unit tests</a>
                            </li>
                            <li class="navitem">
                                <a href="../Visual_Studio_Code/" class="nav-link">Visual Studio Code</a>
                            </li>
                            <li class="navitem">
                                <a href="../Workflows/" class="nav-link">Navigate stack of failed test</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Tools-PyCharm/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../Unit_tests/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#type-hints" class="nav-link">Type hints</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#why-we-use-type-hints" class="nav-link">Why we use type hints</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#what-to-annotate-with-type-hints" class="nav-link">What to annotate with type hints</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#conventions" class="nav-link">Conventions</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#empty-return" class="nav-link">Empty return</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#invoke-tasks" class="nav-link">Invoke tasks</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#annotation-for-kwargs" class="nav-link">Annotation for kwargs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#any" class="nav-link">Any</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#nparray-and-npndarray" class="nav-link">np.array and np.ndarray</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#handling-the-annoying-incompatible-types-in-assignment" class="nav-link">Handling the annoying Incompatible types in assignment</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#handling-the-annoying-none-has-no-attribute" class="nav-link">Handling the annoying "None" has no attribute</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#disabling-mypy-errors" class="nav-link">Disabling mypy errors</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#what-to-do-when-you-dont-know-what-to-do" class="nav-link">What to do when you don't know what to do</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#library-without-types" class="nav-link">Library without types</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#inferring-types-using-unit-tests" class="nav-link">Inferring types using unit tests</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="type-hints">Type hints</h1>
<!-- toc -->

<ul>
<li><a href="#why-we-use-type-hints">Why we use type hints</a></li>
<li><a href="#what-to-annotate-with-type-hints">What to annotate with type hints</a></li>
<li><a href="#conventions">Conventions</a><ul>
<li><a href="#empty-return">Empty return</a></li>
<li><a href="#invoke-tasks">Invoke tasks</a></li>
<li><a href="#annotation-for-kwargs">Annotation for kwargs</a></li>
<li><a href="#any">Any</a></li>
<li><a href="#nparray-and-npndarray">np.array and np.ndarray</a></li>
</ul>
</li>
<li><a href="#handling-the-annoying-incompatible-types-in-assignment">Handling the annoying Incompatible types in assignment</a></li>
<li><a href="#handling-the-annoying-none-has-no-attribute">Handling the annoying "None" has no attribute</a></li>
<li><a href="#disabling-mypy-errors">Disabling mypy errors</a></li>
<li><a href="#what-to-do-when-you-dont-know-what-to-do">What to do when you don't know what to do</a></li>
<li><a href="#library-without-types">Library without types</a></li>
<li><a href="#inferring-types-using-unit-tests">Inferring types using unit tests</a></li>
</ul>
<!-- tocstop -->

<h1 id="why-we-use-type-hints">Why we use type hints</h1>
<ul>
<li>
<p>We use Python 3 type hints to:</p>
</li>
<li>
<p>Improve documentation</p>
</li>
<li>Allow mypy to perform static checking of the code, looking for bugs</li>
<li>Enforce the type checks at run-time, through automatic assertions (not implemented yet)</li>
</ul>
<h1 id="what-to-annotate-with-type-hints">What to annotate with type hints</h1>
<ul>
<li>We expect all new library code (i.e., that is not in a notebook) to have type
  annotations</li>
<li>We annotate the function signature</li>
<li>We don't annotate the variables inside a function unless mypy reports that it
  can't infer the type</li>
<li>We strive to get no errors / warnings from the linter, including mypy</li>
</ul>
<h1 id="conventions">Conventions</h1>
<h2 id="empty-return">Empty return</h2>
<ul>
<li>
<p>Return <code>-&gt; None</code> if your function doesn't return</p>
</li>
<li>
<p>Pros:</p>
<ul>
<li><code>mypy</code> checks functions only when there is at least an annotation: so using
  <code>-&gt; None</code> enables mypy to do type checking</li>
<li>It reminds us that we need to use type hints</li>
</ul>
</li>
<li>Cons:<ul>
<li><code>None</code> is the default value and so it might seem redundant</li>
</ul>
</li>
</ul>
<h2 id="invoke-tasks">Invoke tasks</h2>
<ul>
<li>
<p>For some reason <code>invoke</code> does not like type hints, so we</p>
</li>
<li>
<p>Omit type hints for <code>invoke</code> tasks, i.e. functions with the <code>@task</code> decorator</p>
</li>
<li>
<p>Put <code># type: ignore</code> so that <code>mypy</code> does not complain</p>
</li>
<li>
<p>Example:
  <code>python
  @task 
  def run_qa_tests( # type: ignore 
    ctx, 
    stage="dev", 
    version="", 
  ):</code></p>
</li>
</ul>
<h2 id="annotation-for-kwargs">Annotation for <code>kwargs</code></h2>
<ul>
<li>We use <code>kwargs: Any</code> and not <code>kwargs: Dict[str, Any]</code></li>
<li><code>*</code> always binds to a <code>Tuple</code>, and <code>**</code> always binds to a <code>Dict[str, Any]</code>.
  Because of this restriction, type hints only need you to define the types of
  the contained arguments. The type checker automatically adds the
  <code>Tuple[_, ...]</code> and <code>Dict[str, _]</code> container types.</li>
<li><a href="https://adamj.eu/tech/2021/05/11/python-type-hints-args-and-kwargs/">Reference article</a></li>
</ul>
<h2 id="any"><code>Any</code></h2>
<ul>
<li><code>Any</code> type hint = no type hint</li>
<li>We try to avoid it everywhere when possible</li>
</ul>
<h2 id="nparray-and-npndarray"><code>np.array</code> and <code>np.ndarray</code></h2>
<ul>
<li>If you get something like the following lint:
  <code>bash
  dataflow/core/nodes/sklearn_models.py:537:[amp_mypy] error: Function "numpy.core.multiarray.array" is not valid as a type [valid-type]</code></li>
<li>Then the problem is probably that a parameter that the lint is related to
  has been typed as <code>np.array</code> while it should be typed as <code>np.ndarray</code>:
  <code>python
  `x_vals: np.array` -&gt; `x_vals: np.ndarray`</code></li>
</ul>
<h1 id="handling-the-annoying-incompatible-types-in-assignment">Handling the annoying <code>Incompatible types in assignment</code></h1>
<ul>
<li><code>mypy</code> assigns a single type to each variable for its entire scope</li>
<li>The problem is in common idioms where we use the same variable to store
  different representations of the same data
  <code>python
  output : str = ...
  output = output.split("\n")
  ...
  # Process output.
  ...
  output = "\n".join(output)</code></li>
<li>Unfortunately the proper solution is to use different variables
  <code>python
  output : str = ...
  output_as_array = output.split("\n")
  ...
  # Process output.
  ...
  output = "\n".join(output_as_array)</code></li>
<li>Another case could be:
  <code>python
  from typing import Optional
  def test_func(arg: bool):
  ...
  var: Optional[bool] = ...
  dbg.dassert_is_not(var, None)
  test_func(arg=var)</code></li>
<li>Sometimes <code>mypy</code> doesn't pick up the <code>None</code> check, and warns that the function
  expects a <code>bool</code> rather than an <code>Optional[bool]</code>. In that case, the solution
  is to explicitly use <code>typing.cast</code> on the argument when passing it in, note
  that <code>typing.cast</code> has no runtime effects and is purely for type checking.</li>
<li>Here're the relevant <a href="https://mypy.readthedocs.io/en/stable/casts.html">docs</a></li>
<li>So the solution would be:
  <code>python
  from typing import cast ...
  ...
  test_func(arg=cast(bool, var))</code></li>
</ul>
<h1 id="handling-the-annoying-none-has-no-attribute">Handling the annoying <code>"None" has no attribute</code></h1>
<ul>
<li>In some model classes <code>self._model</code> parameter is being assigned to <code>None</code> in
  ctor and being set after calling <code>set_fit_state</code> method</li>
<li>The problem is that statically it's not possible to understand that someone
  will call <code>set_fit_state</code> before using <code>self._model</code>, so when a model's method
  is applied:
  <code>python
  self._model = self._model.fit(...)</code>
  the following lint appears:
  <code>bash
  dataflow/core/nodes/sklearn_models.py:155:[amp_mypy] error: "None" has no attribute "fit"</code></li>
<li>A solution is to</li>
<li>Type hint when assigning the model parameter in ctor:
     <code>python
     self._model: Optional[sklearn.base.BaseEstimator] = None</code></li>
<li>Cast a type to the model parameter after asserting that it is not <code>None</code>:
     <code>python
     hdbg.dassert_is_not(self._model, None)
     self._model = cast(sklearn.base.BaseEstimator, self._model)</code></li>
</ul>
<h1 id="disabling-mypy-errors">Disabling <code>mypy</code> errors</h1>
<ul>
<li>If <code>mypy</code> reports an error and you don't understand why, please ping one of
  the python experts asking for help</li>
<li>If you are sure that you understand why <code>mypy</code> reports and error and that you
  can override it, you disable this <code>error</code></li>
<li>When you want to disable an error reported by <code>mypy</code>:</li>
<li>Add a comment reporting the <code>mypy</code> error</li>
<li>Explain why this is not a problem</li>
<li>Add <code># type: ignore</code> with two spaces as usual for the inline comment</li>
<li>Example
    <code>python
    # mypy: Cannot find module named 'pyannotate_runtime'
    # pyannotate is not always installed
    from pyannotate_runtime import collect_types # type: ignore</code></li>
</ul>
<h1 id="what-to-do-when-you-dont-know-what-to-do">What to do when you don't know what to do</h1>
<ul>
<li>Go to the <a href="https://mypy.readthedocs.io/en/stable/cheat_sheet_py3.html"><code>mypy</code> official cheat sheet</a></li>
<li>Use <code>reveal_type</code></li>
<li>To find out what type <code>mypy</code> infers for an expression anywhere in your
    program, wrap it in <code>reveal_type()</code></li>
<li><code>mypy</code> will print an error message with the type; remove it again before
    running the code</li>
<li>See <a href="https://mypy.readthedocs.io/en/stable/cheat_sheet_py3.html#when-you-re-puzzled-or-when-things-are-complicated">the official <code>mypy</code> documentation</a></li>
</ul>
<h1 id="library-without-types">Library without types</h1>
<ul>
<li><code>mypy</code> is unhappy when a library doesn't have types</li>
<li>Lots of libraries are starting to add type hints now that python 2 has been
  deprecated
  <code>bash
  *.py:14: error: No library stub file for module 'sklearn.model_selection' [mypy]</code></li>
<li>You can go in <code>mypy.ini</code> and add the library (following the alphabetical
  order) to the list</li>
<li>Note that you need to ensure that different copies of <code>mypy.ini</code> in different
  sub projects are equal
  ```bash<blockquote>
<p>vimdiff mypy.ini amp/mypy.ini
  or
cp mypy.ini amp/mypy.ini
  ```</p>
</blockquote>
</li>
</ul>
<h1 id="inferring-types-using-unit-tests">Inferring types using unit tests</h1>
<ul>
<li>
<p>Sometimes it is possible to infer types directly from unit tests. We have used
this flow to annotate the code when we switched to Python3 and it worked fine
although there were various mistakes. We still prefer to annotate by hand based
on what the code is intended to do, rather than automatically infer it from how
the code behaves.</p>
</li>
<li>
<p>Install <code>pyannotate</code>
    <code>bash
    &gt; pip install pyannotate</code></p>
</li>
<li>To enable collecting type hints run
    <code>bash
    &gt; export PYANNOTATE=True</code></li>
<li>Run <code>pytest</code>, e.g., on a subset of unit tests:</li>
<li>Run <code>pytest</code>, e.g., on a subset of unit tests like <code>helpers</code>:
    <code>bash
    &gt; pytest helpers</code></li>
<li>A file <code>type_info.json</code> is generated</li>
<li>Annotate the code with the inferred types:
    <code>bash
    &gt; pyannotate -w --type-info type_info.json . --py3</code></li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
