<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Development Workflow - My Docs</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Welcome to MkDocs</a>
                            </li>
                            <li class="navitem">
                                <a href="../Buildmeister_process/" class="nav-link">Buildmeister process</a>
                            </li>
                            <li class="navitem">
                                <a href="../Code_review/" class="nav-link">Code review</a>
                            </li>
                            <li class="navitem">
                                <a href="../Codebase_clean_up_scripts/" class="nav-link">Codebase clean-up scripts</a>
                            </li>
                            <li class="navitem">
                                <a href="../Coding_Style_Guide/" class="nav-link">Sorrentum - Python Style Guide</a>
                            </li>
                            <li class="navitem">
                                <a href="../Contributor_Scorecard/" class="nav-link">Contributor Scorecard</a>
                            </li>
                            <li class="navitem">
                                <a href="../DataFlow/" class="nav-link">DataFlow specification</a>
                            </li>
                            <li class="navitem">
                                <a href="../DataPull/" class="nav-link">DataPull</a>
                            </li>
                            <li class="navitem">
                                <a href="../Design_Philosophy/" class="nav-link">Design Philosophy</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">Development Workflow</a>
                            </li>
                            <li class="navitem">
                                <a href="../Docker/" class="nav-link">Docker</a>
                            </li>
                            <li class="navitem">
                                <a href="../Documentation_about_guidelines/" class="nav-link">Documentation about guidelines</a>
                            </li>
                            <li class="navitem">
                                <a href="../Email/" class="nav-link">Email</a>
                            </li>
                            <li class="navitem">
                                <a href="../First_review_process/" class="nav-link">First Review Process</a>
                            </li>
                            <li class="navitem">
                                <a href="../From_zero_to_modeling/" class="nav-link">From zero to modeling</a>
                            </li>
                            <li class="navitem">
                                <a href="../General_rules_of_collaboration/" class="nav-link">General Rules of Collaboration</a>
                            </li>
                            <li class="navitem">
                                <a href="../GitHub_ZenHub_workflows/" class="nav-link">GitHub/ZenHub workflows</a>
                            </li>
                            <li class="navitem">
                                <a href="../Git_workflow_and_best_practices/" class="nav-link">Git workflow and best practices</a>
                            </li>
                            <li class="navitem">
                                <a href="../Glossary/" class="nav-link">Glossary</a>
                            </li>
                            <li class="navitem">
                                <a href="../Gsheet_into_pandas/" class="nav-link">Gsheet into pandas</a>
                            </li>
                            <li class="navitem">
                                <a href="../HTMLcov_server/" class="nav-link">HTMLcov server</a>
                            </li>
                            <li class="navitem">
                                <a href="../How_to_integrate_repos/" class="nav-link">How to integrate repos</a>
                            </li>
                            <li class="navitem">
                                <a href="../How_to_organize_your_work/" class="nav-link">Golden rules</a>
                            </li>
                            <li class="navitem">
                                <a href="../Imports_and_packages/" class="nav-link">Imports and packages</a>
                            </li>
                            <li class="navitem">
                                <a href="../Jupyter_notebook_best_practices/" class="nav-link">Jupyter notebook best practices</a>
                            </li>
                            <li class="navitem">
                                <a href="../Reading_List/" class="nav-link">Reading List</a>
                            </li>
                            <li class="navitem">
                                <a href="../Receive_crypto_payment/" class="nav-link">Receive crypto payment</a>
                            </li>
                            <li class="navitem">
                                <a href="../Scrum_methodology/" class="nav-link">Scrum Methodology</a>
                            </li>
                            <li class="navitem">
                                <a href="../Signing_up_for_Sorrentum/" class="nav-link">Signing up to the project</a>
                            </li>
                            <li class="navitem">
                                <a href="../Sorrentum_development_setup/" class="nav-link">Sorrentum development setup</a>
                            </li>
                            <li class="navitem">
                                <a href="../Telegram/" class="nav-link">Telegram</a>
                            </li>
                            <li class="navitem">
                                <a href="../Tools-PyCharm/" class="nav-link">Running PyCharm remotely</a>
                            </li>
                            <li class="navitem">
                                <a href="../Type_hints/" class="nav-link">Type hints</a>
                            </li>
                            <li class="navitem">
                                <a href="../Unit_tests/" class="nav-link">Unit tests</a>
                            </li>
                            <li class="navitem">
                                <a href="../Visual_Studio_Code/" class="nav-link">Visual Studio Code</a>
                            </li>
                            <li class="navitem">
                                <a href="../Workflows/" class="nav-link">Navigate stack of failed test</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Design_Philosophy/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../Docker/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#development-workflow" class="nav-link">Development Workflow</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#setting-up-git-credentials" class="nav-link">Setting up Git credentials</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#preamble" class="nav-link">Preamble</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#check-git-credentials" class="nav-link">Check Git credentials</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#setting-git-credentials" class="nav-link">Setting Git credentials</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#enforcing-git-credentials" class="nav-link">Enforcing Git credentials</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#create-the-env" class="nav-link">Create the env</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#invoke" class="nav-link">Invoke</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#listing-all-the-tasks" class="nav-link">Listing all the tasks</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#implementation-details" class="nav-link">Implementation details</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#github" class="nav-link">GitHub</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#see-all-the-workflows" class="nav-link">See all the workflows</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#getting-help-for-a-workflow" class="nav-link">Getting help for a workflow</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#merge-master-in-the-current-branch" class="nav-link">Merge master in the current branch</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#create-a-pr" class="nav-link">Create a PR</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#extract-a-pr-from-a-larger-one" class="nav-link">Extract a PR from a larger one</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#systematic-code-transformation" class="nav-link">Systematic code transformation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#generate-a-local-amp-docker-image" class="nav-link">Generate a local amp Docker image</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#github-actions-ci" class="nav-link">GitHub Actions (CI)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#pytest" class="nav-link">pytest</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#run-with-coverage" class="nav-link">Run with coverage</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#iterating-on-stacktrace-of-failing-test" class="nav-link">Iterating on stacktrace of failing test</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#iterating-on-a-failing-regression-test" class="nav-link">Iterating on a failing regression test</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#detect-mismatches-with-golden-test-outcomes" class="nav-link">Detect mismatches with golden test outcomes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#playback" class="nav-link">Playback</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#publish-a-notebook" class="nav-link">Publish a notebook</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#detailed-instructions" class="nav-link">Detailed instructions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#publish-notebooks" class="nav-link">Publish notebooks</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#open-a-published-notebook" class="nav-link">Open a published notebook</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#how-to-create-a-private-fork" class="nav-link">How to create a private fork</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#integrate-public-to-private-amp-cmamp" class="nav-link">Integrate public to private: amp -&gt; cmamp</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#set-up" class="nav-link">Set-up</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ours-vs-theirs" class="nav-link">Ours vs theirs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sync-the-repos-after-double-integration" class="nav-link">Sync the repos (after double integration)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#updated-sync" class="nav-link">Updated sync</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#check-that-things-are-fine" class="nav-link">Check that things are fine</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#integrate-private-to-public-cmamp-amp" class="nav-link">Integrate private to public: cmamp -&gt; amp</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#squash-commit-of-everything-in-the-branch" class="nav-link">Squash commit of everything in the branch</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#double-integration-cmamp-amp" class="nav-link">Double integration cmamp &lt; -- &gt; amp</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#script-set-up" class="nav-link">Script set-up</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#manual-set-up-branches" class="nav-link">Manual set-up branches</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#high-level-plan" class="nav-link">High-level plan</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sync-im-cmamp-amp" class="nav-link">Sync im cmamp -&gt; amp</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sync-everything" class="nav-link">Sync everything</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#files-that-need-to-be-different" class="nav-link">Files that need to be different</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="development-workflow">Development Workflow</h1>
<!-- toc -->

<ul>
<li><a href="#setting-up-git-credentials">Setting up Git credentials</a></li>
<li><a href="#preamble">Preamble</a></li>
<li><a href="#check-git-credentials">Check Git credentials</a></li>
<li><a href="#setting-git-credentials">Setting Git credentials</a></li>
<li><a href="#enforcing-git-credentials">Enforcing Git credentials</a></li>
<li><a href="#create-the-env">Create the env</a></li>
<li><a href="#invoke">Invoke</a></li>
<li><a href="#listing-all-the-tasks">Listing all the tasks</a></li>
<li><a href="#implementation-details">Implementation details</a></li>
<li><a href="#github">GitHub</a></li>
<li><a href="#see-all-the-workflows">See all the workflows</a></li>
<li><a href="#getting-help-for-a-workflow">Getting help for a workflow</a></li>
<li><a href="#merge-master-in-the-current-branch">Merge master in the current branch</a></li>
<li><a href="#create-a-pr">Create a PR</a></li>
<li><a href="#extract-a-pr-from-a-larger-one">Extract a PR from a larger one</a><ul>
<li><a href="#using-git">Using git</a></li>
</ul>
</li>
<li><a href="#systematic-code-transformation">Systematic code transformation</a></li>
<li><a href="#generate-a-local-amp-docker-image">Generate a local <code>amp</code> Docker image</a></li>
<li><a href="#update-the-dev-amp-docker-image">Update the dev <code>amp</code> Docker image</a></li>
<li><a href="#experiment-in-a-local-image">Experiment in a local image</a></li>
<li><a href="#github-actions-ci">GitHub Actions (CI)</a></li>
<li><a href="#pytest">pytest</a></li>
<li><a href="#run-with-coverage">Run with coverage</a></li>
<li><a href="#iterating-on-stacktrace-of-failing-test">Iterating on stacktrace of failing test</a></li>
<li><a href="#iterating-on-a-failing-regression-test">Iterating on a failing regression test</a></li>
<li><a href="#detect-mismatches-with-golden-test-outcomes">Detect mismatches with golden test outcomes</a></li>
<li><a href="#playback">Playback</a></li>
<li><a href="#publish-a-notebook">Publish a notebook</a></li>
<li><a href="#detailed-instructions">Detailed instructions</a></li>
<li><a href="#publish-notebooks">Publish notebooks</a></li>
<li><a href="#open-a-published-notebook">Open a published notebook</a><ul>
<li><a href="#start-a-server">Start a server</a></li>
<li><a href="#using-the-dev-box">Using the dev box</a></li>
<li><a href="#using-windows-browser">Using Windows browser</a></li>
</ul>
</li>
<li><a href="#how-to-create-a-private-fork">How to create a private fork</a></li>
<li><a href="#integrate-public-to-private-amp---cmamp">Integrate public to private: <code>amp</code> -&gt; <code>cmamp</code></a></li>
<li><a href="#set-up">Set-up</a></li>
<li><a href="#ours-vs-theirs">Ours vs theirs</a></li>
<li><a href="#sync-the-repos-after-double-integration">Sync the repos (after double integration)</a></li>
<li><a href="#updated-sync">Updated sync</a></li>
<li><a href="#check-that-things-are-fine">Check that things are fine</a></li>
<li><a href="#integrate-private-to-public-cmamp---amp">Integrate private to public: <code>cmamp</code> -&gt; <code>amp</code></a></li>
<li><a href="#squash-commit-of-everything-in-the-branch">Squash commit of everything in the branch</a></li>
<li><a href="#double-integration-cmamp--amp">Double integration <code>cmamp</code> <code>amp</code></a></li>
<li><a href="#script-set-up">Script set-up</a></li>
<li><a href="#manual-set-up-branches">Manual set-up branches</a></li>
<li><a href="#high-level-plan">High-level plan</a></li>
<li><a href="#sync-im-cmamp---amp">Sync <code>im</code> <code>cmamp</code> -&gt; <code>amp</code></a></li>
<li><a href="#sync-everything">Sync everything</a></li>
<li><a href="#files-that-need-to-be-different">Files that need to be different</a><ul>
<li><a href="#lint-everything">Lint everything</a></li>
<li><a href="#testing">Testing</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

<h1 id="setting-up-git-credentials">Setting up Git credentials</h1>
<h2 id="preamble">Preamble</h2>
<ul>
<li>Git allows setting credentials at different "levels":</li>
<li>system (set for all the users in <code>/etc/git</code>)</li>
<li>global (set for a single user in <code>$HOME/.gitconfig</code> or
    <code>$HOME/.config/git/config</code>)</li>
<li>local (set on a per client basis in <code>.git/config</code> in the repo root)</li>
<li>Git uses a hierarchical config approach in which settings of a broader scope
    are inherited if not overridden.</li>
<li>Refs:</li>
<li>How to customize Git:
    https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration</li>
<li>Details on <code>git config</code>: https://git-scm.com/docs/git-config</li>
</ul>
<h2 id="check-git-credentials">Check Git credentials</h2>
<ul>
<li>You can check the Git credentials that will be used to commit in a client by
  running:
  ```bash<blockquote>
<p>git config -l | grep user
  user.name=saggese
  user.email=saggese@gmail.com
  github.user=gpsaggese
  ```</p>
</blockquote>
</li>
<li>To know at which level each variable is defined, run
  ```bash<blockquote>
<p>git config --show-origin user.name
  file:/Users/saggese/.gitconfig saggese
  ```</p>
</blockquote>
</li>
<li>You can see all the <code>Authors</code> in a Git repo history with:
  ```bash<blockquote>
<p>git log | grep -i Author | sort | uniq
  ...
  ```</p>
</blockquote>
</li>
<li>Git doesn't do any validation of <code>user.name</code> and <code>user.email</code> but it just uses
  these values to compose a commit message like:</li>
</ul>
<p>```bash</p>
<blockquote>
<p>git log -2
  commit 31052d05c226b1c9834d954e0c3d5586ed35f41e (HEAD -&gt;
  AmpTask1290_Avoid_committing_to_master_by_mistake)
  Author: saggese <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#115;&#97;&#103;&#103;&#101;&#115;&#101;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#115;&#97;&#103;&#103;&#101;&#115;&#101;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a>
  Date: Mon Jun 21 16:22:25 2021</p>
</blockquote>
<p>Update hooks
  ```</p>
<h2 id="setting-git-credentials">Setting Git credentials</h2>
<ul>
<li>To keep things simple and avoid variability, our convention is to use:</li>
<li>as <code>user.name</code> our Linux user name on the local computer we are using to
    commit which is returned by <code>whoami</code> (e.g., <code>user.name=saggese</code>)</li>
<li>as <code>user.email</code> the email that corresponds to that user (e.g,.
    <code>user.email=saggese@gmail.com</code>)</li>
<li>To accomplish the set-up above you can:</li>
<li>use in <code>/Users/saggese/.gitconfig</code> the values for our open-source account,
    so that they are used by default
  ```bash<blockquote>
<p>git config --global user.name $(whoami)
git config --global user.email YOUR_EMAIL
  ```</p>
</blockquote>
</li>
<li>use the correct user / email in the repos that are not open-source
  ```bash<blockquote>
<p>cd $GIT_ROOT
git config --local user.name $(whoami)
git config --local user.email YOUR_EMAIL
  ```</p>
</blockquote>
</li>
<li>Note that you need to set these local values on each Git client that you have
  cloned, since Git doesn't version control these values</li>
</ul>
<h2 id="enforcing-git-credentials">Enforcing Git credentials</h2>
<ul>
<li>We use Git hooks to enforce that certain emails are used for certain repos
  (e.g., we should commit to our open-source repos only using our personal
  non-corporate email).</li>
<li>You need to install the hooks in each Git client that you use. Conceptually
  this step is part of <code>git clone</code>: every time you clone a repo locally you need
  to set the hooks.</li>
<li>TODO(gp): We could create a script to automate cloning a repo and setting it
  up.</li>
</ul>
<p>```bash</p>
<blockquote>
<p>cd //amp
./dev_scripts/git/git_hooks/install_hooks.py --action install
cd //lem
./amp/dev_scripts/git/git_hooks/install_hooks.py --action install
  ```</p>
</blockquote>
<ul>
<li>This procedure creates some links from <code>.git/hook</code> to the scripts in the repo.</li>
<li>You can also use the action <code>status</code> to see the status and <code>remove</code> to the
  hooks.</li>
</ul>
<h1 id="create-the-env">Create the env</h1>
<ul>
<li>You can follow the
  ```bash
  # Build the client env<blockquote>
<p>dev_scripts/client_setup/build.sh
source dev_scripts/setenv_amp.sh
  ```</p>
</blockquote>
</li>
</ul>
<h1 id="invoke">Invoke</h1>
<ul>
<li>We use <code>invoke</code> to implement workflows (aka "tasks") similar to Makefile
  targets, but using Python.</li>
<li><a href="https://docs.pyinvoke.org/en/0.11.1/index.html">The official documentation.</a></li>
<li>We use <code>invoke</code> to automate tasks and package workflows for:</li>
<li>docker: <code>docker_*</code></li>
<li>Git: <code>git_*</code></li>
<li>GitHub (relying on <code>gh</code> integration): <code>gh_*</code></li>
<li>running tests: <code>run_*</code></li>
<li>integrate: <code>integrate_*</code></li>
<li>releasing tools and Docker images: <code>docker_*</code></li>
<li>lint: <code>lint_*</code></li>
<li>pytest:</li>
<li>Each set of commands starts with the topic, e.g., <code>docker_*</code> for all the
  docker elated tasks</li>
<li>The best approach to getting familiar with the tasks is to browse the list and
  then check the output of the help</li>
</ul>
<p>```bash</p>
<blockquote>
<p>invoke --help command
i -h gh_issue_title
  Usage: inv[oke] [--core-opts] gh_issue_title [--options] [other tasks here ...]</p>
</blockquote>
<p>Docstring:
  Print the title that corresponds to the given issue and repo_short_name.
  E.g., AmpTask1251_Update_GH_actions_for_amp.</p>
<p>:param pbcopy: save the result into the system clipboard (only on macOS)</p>
<p>Options:
  -i STRING, --issue-id=STRING
  -p, --[no-]pbcopy
  -r STRING, --repo-short-name=STRING
  ```</p>
<ul>
<li>I can guarantee you a 2x improvement in performance, if you master the
  workflows, but it takes some time and patience</li>
</ul>
<h2 id="listing-all-the-tasks">Listing all the tasks</h2>
<pre><code class="language-bash">&gt; invoke --list
INFO: &gt; cmd='/Users/saggese/src/venv/amp.client_venv/bin/invoke --list'
Available tasks:

check_python_files Compile and execute Python files checking for errors.
docker_bash Start a bash shell inside the container corresponding to a stage.
docker_build_local_image Build a local image (i.e., a release candidate &quot;dev&quot;
image).
docker_build_prod_image (ONLY CI/CD) Build a prod image.
docker_cmd Execute the command `cmd` inside a container corresponding to a
stage.
docker_images_ls_repo List images in the logged in repo_short_name.
docker_jupyter Run jupyter notebook server.
docker_kill Kill the last Docker container started.
docker_login Log in the AM Docker repo_short_name on AWS.
docker_ps List all the running containers.
docker_pull Pull latest dev image corresponding to the current repo from the
registry.
docker_pull_dev_tools Pull latest prod image of `dev_tools` from the registry.
docker_push_dev_image (ONLY CI/CD) Push the &quot;dev&quot; image to ECR.
docker_push_prod_image (ONLY CI/CD) Push the &quot;prod&quot; image to ECR.
docker_release_all (ONLY CI/CD) Release both dev and prod image to ECR.
docker_release_dev_image (ONLY CI/CD) Build, test, and release to ECR the latest
&quot;dev&quot; image.
docker_release_prod_image (ONLY CI/CD) Build, test, and release to ECR the prod
image.
docker_rollback_dev_image Rollback the version of the dev image.
docker_rollback_prod_image Rollback the version of the prod image.
docker_stats Report last started Docker container stats, e.g., CPU, RAM.
docker_tag_local_image_as_dev (ONLY CI/CD) Mark the &quot;local&quot; image as &quot;dev&quot;.
find_check_string_output Find output of check_string() in the test running
find_test_class Report test files containing `class_name` in a format compatible
with
find_test_decorator Report test files containing `class_name` in pytest format.
fix_perms :param action:
gh_create_pr Create a draft PR for the current branch in the corresponding
gh_issue_title Print the title that corresponds to the given issue and
repo_short_name.
gh_workflow_list Report the status of the GH workflows.
gh_workflow_run Run GH workflows in a branch.
git_add_all_untracked Add all untracked files to Git.
git_branch_copy Create a new branch with the same content of the current branch.
git_branch_diff_with_base Diff files of the current branch with master at the
branching point.
git_branch_files Report which files were added, changed, and modified in the
current branch
git_branch_next_name Return a name derived from the branch so that the branch
does not exist.
git_clean Clean the repo_short_name and its submodules from artifacts.
git_create_branch Create and push upstream branch `branch_name` or the one
corresponding to
git_create_patch Create a patch file for the entire repo_short_name client from
the base
git_delete_merged_branches Remove (both local and remote) branches that have
been merged into master.
git_files Report which files are changed in the current branch with respect to
git_last_commit_files Print the status of the files in the previous commit.
git_merge_master Merge `origin/master` into the current branch.
git_pull Pull all the repos.
git_fetch_master Pull master without changing branch.
git_rename_branch Rename current branch both locally and remotely.
integrate_compare_branch_with_base Compare the files modified in both the
branches in src_dir and dst_dir to
integrate_copy_dirs Copy dir `subdir` from dir `src_dir` to `dst_dir`.
integrate_create_branch Create the branch for integration in the current dir.
integrate_diff_dirs Integrate repos from dir `src_dir` to `dst_dir`.
lint Lint files.
lint_create_branch Create the branch for linting in the current dir.
print_setup Print some configuration variables.
print_tasks Print all the available tasks in `lib_tasks.py`.
pytest_clean Clean pytest artifacts.
pytest_compare Compare the output of two runs of `pytest -s --dbg` removing
irrelevant
pytest_failed Process the list of failed tests from a pytest run.
pytest_failed_freeze_test_list Copy last list of failed tests to not overwrite
with successive pytest
run_blank_tests (ONLY CI/CD) Test that pytest in the container works.
run_coverage_report
run_fast_slow_tests Run fast and slow tests independently.
run_fast_tests Run fast tests.
run_qa_tests Run QA tests independently.
run_slow_tests Run slow tests.
run_superslow_tests Run superslow tests.
traceback Parse the traceback from Pytest and navigate it with vim.
</code></pre>
<h2 id="implementation-details">Implementation details</h2>
<ul>
<li>By convention all invoke targets are in <code>*_lib_tasks.py</code>, e.g.,</li>
<li><code>helpers/lib_tasks.py</code> - tasks to be run in <code>cmamp</code></li>
<li><code>optimizer/opt_lib_tasks.py</code> - tasks to be run in <code>cmamp/optimizer</code></li>
<li>All invoke tasks are functions with the <code>@task</code> decorator, e.g.,</li>
</ul>
<p>```python
  from invoke import task</p>
<p>@task
  def invoke_task(...):
    ...
  ```</p>
<ul>
<li>To run a task we use <code>context.run(...)</code>, see
  <a href="https://docs.pyinvoke.org/en/0.11.1/concepts/context.html">the official docs</a></li>
<li>To be able to run a specified invoke task one should import it in <code>tasks.py</code></li>
<li>E.g., see <code>cmamp/tasks.py</code></li>
<li>A task can be run only in a dir where it is imported in a corresponding
  <code>tasks.py</code>, e.g.,</li>
<li><code>invoke_task1</code> is imported in <code>cmamp/tasks.py</code> so it can be run only from
    <code>cmamp</code></li>
<li><code>invoke_task2</code> is imported in <code>cmamp/optimizer/tasks.py</code> so it can be run
    only from <code>cmamp/optimizer</code><ul>
<li>In other words one should do <code>cd cmamp/optimizer</code> before doing
  <code>i invoke_task2 ...</code></li>
</ul>
</li>
</ul>
<h2 id="github">GitHub</h2>
<ul>
<li>Get the official branch name corresponding to an Issue</li>
</ul>
<p>```bash</p>
<blockquote>
<p>i gh_issue_title -i 256
  ## gh_issue_title: issue_id='256', repo_short_name='current'</p>
</blockquote>
<p># Copied to system clipboard:
  AmpTask256_Part_task2236_jenkins_cleanup_split_scripts:
  https://github.com/alphamatic/amp/pull/256
  ```</p>
<h2 id="see-all-the-workflows">See all the workflows</h2>
<ul>
<li>Workflows are organized somehow around Linux command that they are related to,
  e.g.,</li>
<li><code>docker_*</code> for all <code>docker</code> related workflows</li>
<li><code>find_*</code> for all workflows related to finding (e.g., unit tests)</li>
<li><code>gh_*</code> for GitHub related workflows</li>
<li><code>git_*</code> for Git related workflows</li>
<li>etc.</li>
<li>Once in a while it can be useful to list all the available workflows and see
  if something interesting was added.</li>
</ul>
<p>```bash</p>
<blockquote>
<p>invoke --list
  Available tasks:</p>
</blockquote>
<p>docker_bash     Start a bash shell inside the container corresponding to a stage.
  docker_build_local_image    Build a local image (i.e., a release candidate "dev" image).
  ...
  ```</p>
<h2 id="getting-help-for-a-workflow">Getting help for a workflow</h2>
<ul>
<li>You can get a more detailed help with</li>
</ul>
<p>```bash</p>
<blockquote>
<p>invoke --help run_fast_tests
  Usage: inv[oke] [--core-opts] run_fast_tests [--options] [other tasks here ...]</p>
</blockquote>
<p>Docstring:
  Run fast tests.</p>
<p>:param stage: select a specific stage for the Docker image
  :param pytest_opts: option for pytest
  :param pytest_mark: test list to select as <code>@pytest.mark.XYZ</code>
  :param dir_name: dir to start searching for tests
  :param skip_submodules: ignore all the dir inside a submodule
  :param coverage: enable coverage computation
  :param collect_only: do not run tests but show what will be executed</p>
<p>Options:
  -c, --coverage
  -d STRING, --dir-name=STRING
  -k, --skip-submodules
  -o, --collect-only
  -p STRING, --pytest-opts=STRING
  -s STRING, --stage=STRING
  -y STRING, --pytest-mark=STRING
  ```</p>
<h2 id="merge-master-in-the-current-branch">Merge master in the current branch</h2>
<pre><code class="language-bash">&gt; i git_merge_master
</code></pre>
<h2 id="create-a-pr">Create a PR</h2>
<p>TODO(gp): Describe</p>
<h2 id="extract-a-pr-from-a-larger-one">Extract a PR from a larger one</h2>
<ul>
<li>My workflow is to have a feature branch (e.g.,
  <code>AmpTask1891_Sketch_out_the_design_of_RT_OMS</code>) that I develop in.</li>
<li>When a piece of code can be merged:</li>
<li>create a new branch (e.g., <code>AmpTask1891_Sketch_out_the_design_of_RT_OMS_02</code>)</li>
<li>copy the current feature branch to the new branch</li>
<li>remove the pieces that you don't want to merge</li>
<li>run regressions</li>
<li>PR</li>
<li>merge into master</li>
<li>merge master into the feature branch</li>
<li>This workflow allows you to develop and regress / merge without too much
  hassle solving the problem of "stacked PRs".</li>
</ul>
<p>```bash
  # Go to the client with the branch that you want to divvy up.</p>
<blockquote>
<p>git checkout ${feature_branch}</p>
</blockquote>
<p># Make sure that the branch is up-to-date with master</p>
<blockquote>
<p>i git_merge_master</p>
</blockquote>
<p># Lint.</p>
<blockquote>
<p>i lint -b</p>
</blockquote>
<p># Create a patch from the branch (there are many options to tweak the workflow, check the help)</p>
<blockquote>
<p>i git_create_patch -b</p>
</blockquote>
<p># To apply the patch and execute:</p>
<blockquote>
<p>git checkout 8f9cda97
git apply /Users/saggese/src/lemonade1/amp/patch.amp.8f9cda97.20210609_080439.patch
  ...
  ```</p>
</blockquote>
<ul>
<li>Go to a fresh Git client (I have 2-3 Git clients separated from the one in
  which I develop for this kind of operations) or go to master in the same Git
  client</li>
</ul>
<p>```bash
  # Go to master</p>
<blockquote>
<p>git checkout master</p>
</blockquote>
<p># Apply the patch from the run of <code>git_create_patch</code></p>
<blockquote>
<p>git apply
/Users/saggese/src/lemonade1/amp/patch.amp.8f9cda97.20210609_080439.patch</p>
</blockquote>
<p># This patch should apply cleanly and with no errors from git, otherwise it means
  that your feature branch does not have the latest master</p>
<p># Remove what you don't want to commit.</p>
<p># Do not change anything or run the linter otherwise your feature branch will not
  merge easily.</p>
<blockquote>
<p>git diff
git checkout master -- ...
  ...
git commit; git push</p>
</blockquote>
<p># Create a PR (non-draft so that GH can start running the tests)</p>
<blockquote>
<p>i gh_create_pr --no-draft</p>
</blockquote>
<p># Regress the branch</p>
<blockquote>
<p>i run_fast_tests ...</p>
</blockquote>
<p># Merge the PR into master</p>
<p># Go back to your feature branch and merge master</p>
<blockquote>
<p>gco ${feature_branch}
git pull</p>
</blockquote>
<p># Now one piece of your feature branch has been merged and you can repeat until
  all the code is merged.
  ```</p>
<h3 id="using-git">Using git</h3>
<pre><code class="language-bash">&gt; git checkout `dst_branch`
&gt; git merge --squash --ff `src_branch`
&gt; git reset HEAD
</code></pre>
<h2 id="systematic-code-transformation">Systematic code transformation</h2>
<ul>
<li>See the help of <code>amp/dev_scripts/replace_text.py</code></li>
</ul>
<h2 id="generate-a-local-amp-docker-image">Generate a local <code>amp</code> Docker image</h2>
<ul>
<li>This is a manual flow used to test and debug images before releasing them to
  the team.</li>
<li>The flow is similar to the dev image, but by default tests are not run and the
  image is not released.</li>
</ul>
<p>```bash
  # Build the local image (and update Poetry dependencies, if needed).</p>
<blockquote>
<p>i docker_build_local_image --update-poetry
  ...
  docker image ls 665840871993.dkr.ecr.us-east-1.amazonaws.com/amp:local</p>
</blockquote>
<p>REPOSITORY TAG IMAGE ID CREATED SIZE
  665840871993.dkr.ecr.us-east-1.amazonaws.com/amp local 9b3f8f103a2c 1 second ago 1.72GB</p>
<p># Test the new "local" image</p>
<blockquote>
<p>i docker_bash --stage "local" python -c "import async_solipsism" python -c
"import async_solipsism; print(async_solipsism.<strong>version</strong>)"</p>
</blockquote>
<p># Run the tests with local image
  # Make sure the new image is used: e.g., add an import and trigger the tests.</p>
<blockquote>
<p>i run_fast_tests --stage "local" --pytest-opts core/dataflow/test/test_real_time.py
i run_fast_slow_tests --stage "local"</p>
</blockquote>
<p># Promote a local image to dev.</p>
<blockquote>
<p>i docker_tag_local_image_as_dev
i docker_push_dev_image
  ```</p>
</blockquote>
<p>## Update the dev <code>amp</code> Docker image</p>
<ul>
<li>To implement the entire Docker QA process of a dev image</li>
</ul>
<p>```bash
  # Clean all the Docker images locally, to make sure there is no hidden state.</p>
<blockquote>
<p>docker system prune --all</p>
</blockquote>
<p># Update the needed packages.</p>
<blockquote>
<p>devops/docker_build/pyproject.toml</p>
</blockquote>
<p># Visually inspect the updated packages.</p>
<blockquote>
<p>git diff devops/docker_build/poetry.lock</p>
</blockquote>
<p># Run entire release process.</p>
<blockquote>
<p>i docker_release_dev_image
  ```</p>
</blockquote>
<p>## Experiment in a local image</p>
<ul>
<li>To install packages in an image, do <code>i docker_bash</code></li>
</ul>
<p>```bash
  # Switch to root and install package.</p>
<blockquote>
<p>sudo su -
source /venv/bin/activate
pip install <package></p>
</blockquote>
<p># Switch back to user.</p>
<blockquote>
<p>exit
  ```</p>
</blockquote>
<ul>
<li>You should test that the package is installed for your user, e.g.,
  ```bash<blockquote>
<p>source /venv/bin/activate python -c "import foobar; print(foobar);print(foobar.<strong>version</strong>)"
  ```</p>
</blockquote>
</li>
<li>You can now use the package in this container. Note that if you exit the
  container, the modified image is lost, so you need to install it again.</li>
<li>You can save the modified image, tagging the new image as local, while the
  container is still running.</li>
<li>Copy your Container ID. You can find it</li>
<li>in the docker bash session, e.g., if the command line in the container
    starts with <code>user_1011@da8f3bb8f53b:/app$</code>, your Container ID is
    <code>da8f3bb8f53b</code></li>
<li>by listing running containers, e.g., run <code>docker ps</code> outside the container</li>
<li>Commit image
  ```bash<blockquote>
<p>docker commit <Container ID> <IMAGE>/cmamp:local-$USER
  ```</p>
</blockquote>
</li>
<li>E.g.
    <code>docker commit da8f3bb8f53b 665840871993.dkr.ecr.us-east-1.amazonaws.com/cmamp:local-julias</code></li>
<li>If you are running inside a notebook using <code>i docker_jupyter</code> you can install
  packages using a one liner <code>! sudo su -; source ...;</code></li>
</ul>
<h1 id="github-actions-ci">GitHub Actions (CI)</h1>
<pre><code class="language-bash">## Running a single test in GH Actions

Create a branch

Change .github/workflows/fast_tests.yml

run: invoke run_fast_tests

## run: invoke run_fast_tests

--pytest-opts=&quot;helpers/test/test_git.py::Test_git_modified_files1::test_get_modified_files_in_branch1
-s --dbg&quot;

# In the current implementation (where we try to not run for branches) to run in a branch
</code></pre>
<h1 id="pytest">pytest</h1>
<ul>
<li>From https://gist.github.com/kwmiebach/3fd49612ef7a52b5ce3a</li>
</ul>
<h2 id="run-with-coverage">Run with coverage</h2>
<pre><code class="language-bash">&gt; i run_fast_tests --pytest-opts=&quot;core/test/test_finance.py&quot; --coverage
</code></pre>
<h2 id="iterating-on-stacktrace-of-failing-test">Iterating on stacktrace of failing test</h2>
<ul>
<li>Inside docker bash
  ```bash<blockquote>
<p>pytest ...
  ```</p>
</blockquote>
</li>
<li>The test fails: switch to using <code>pytest.sh</code> to save the stacktrace to a file</li>
<li>Then from outside Docker launch vim in quickfix mode</li>
</ul>
<p>```bash</p>
<blockquote>
<p>invoke traceback
  ```</p>
</blockquote>
<ul>
<li>The short form is <code>it</code></li>
</ul>
<h2 id="iterating-on-a-failing-regression-test">Iterating on a failing regression test</h2>
<ul>
<li>The workflow is:</li>
</ul>
<p>```bash
  # Run a lot of tests, e.g., the entire regression suite.</p>
<blockquote>
<p>pytest ...
  # Some tests fail.</p>
</blockquote>
<p># Run the <code>pytest_repro</code> to summarize test failures and to generate commands to reproduce them.</p>
<blockquote>
<p>invoke pytest_repro
  ```</p>
</blockquote>
<h2 id="detect-mismatches-with-golden-test-outcomes">Detect mismatches with golden test outcomes</h2>
<ul>
<li>The command is</li>
</ul>
<p>```bash</p>
<blockquote>
<p>i pytest_find_unused_goldens
  ```</p>
</blockquote>
<ul>
<li>The specific dir to check can be specified with the <code>dir_name</code> parameter.</li>
<li>The invoke detects and logs mismatches between the tests and the golden
  outcome files.</li>
<li>When goldens are required by the tests but the corresponding files do not
    exist<ul>
<li>This usually happens if the tests are skipped or commented out.</li>
<li>Sometimes it's a FP hit (e.g. the method doesn't actually call
  <code>check_string</code> but instead has it in a string, or <code>check_string</code> is called
  on a missing file on purpose to verify that an exception is raised).</li>
</ul>
</li>
<li>When the existing golden files are not actually required by the
    corresponding tests.<ul>
<li>In most cases it means the files are outdated and can be deleted.</li>
<li>Alternatively, it can be a FN hit: the test method A, which the golden
  outcome corresponds to, doesn't call <code>check_string</code> directly, but the
  test's class inherits from a different class, which in turn has a method B
  that calls <code>check_string</code>, and this method B is called in the test method
  A.</li>
</ul>
</li>
<li>For more details see
  <a href="https://github.com/cryptokaizen/cmamp/issues/528">CmTask528</a>.</li>
</ul>
<h1 id="playback">Playback</h1>
<h1 id="publish-a-notebook">Publish a notebook</h1>
<ul>
<li><code>publish_notebook.py</code> is a little tool that allows to:</li>
<li>Opening a notebook in your browser (useful for read-only mode)<ul>
<li>E.g., without having to use Jupyter notebook (which modifies the file in
   your client) or github preview (which is slow or fails when the notebook
   is too large)</li>
</ul>
</li>
<li>Sharing a notebook with others in a simple way</li>
<li>Pointing to detailed documentation in your analysis Google docs</li>
<li>Reviewing someone's notebook</li>
<li>Comparing multiple notebooks against each other in different browser
     windows</li>
<li>Taking a snapshot / checkpoint of a notebook as a backup or before making
     changes<ul>
<li>This is a lightweight alternative to "unit testing" to capture the
   desired behavior of a notebook</li>
<li>One can take a snapshot and visually compare multiple notebooks
   side-by-side for changes</li>
</ul>
</li>
</ul>
<h2 id="detailed-instructions">Detailed instructions</h2>
<ul>
<li>You can get details by running:</li>
</ul>
<p>```bash</p>
<blockquote>
<p>dev_scripts/notebooks/publish_notebook.py -h
  ```</p>
</blockquote>
<ul>
<li>Plug-in for Chrome
  <a href="https://chrome.google.com/webstore/detail/my-s3-browser/lgkbddebikceepncgppakonioaopmbkk?hl=en">my-s3-browser</a></li>
</ul>
<h2 id="publish-notebooks">Publish notebooks</h2>
<ul>
<li>Make sure that your environment is set up properly</li>
</ul>
<p>```bash</p>
<blockquote>
<p>more ~/.aws/credentials
  [am]
  aws_access_key_id=<strong>
  aws_secret_access_key=</strong>
  aws_s3_bucket=alphamatic-data</p>
<p>printenv | grep AM_
  AM_AWS_PROFILE=am
  ```</p>
</blockquote>
<ul>
<li>If you don't have them, you need to re-run <code>source dev_scripts/setenv.sh</code> in
  all the shells. It might be easier to kill that tmux session and restart it</li>
</ul>
<p>```bash</p>
<blockquote>
<p>tmux kill-session --t limeXYZ</p>
<p>~/go_lem.sh XYZ
  ```</p>
</blockquote>
<ul>
<li>Inside or outside a Docker bash run</li>
</ul>
<p>```bash</p>
<blockquote>
<p>publish_notebook.py --file http://127.0.0.1:2908/notebooks/notebooks/Task40_Optimizer.ipynb --action publish_on_s3
  ```</p>
</blockquote>
<ul>
<li>The file is copied to S3</li>
</ul>
<p><code>bash
  Copying './Task40_Optimizer.20210717_010806.html' to
  's3://alphamatic-data/notebooks/Task40_Optimizer.20210717_010806.html'</code></p>
<ul>
<li>You can also save the data locally:</li>
</ul>
<p>```bash</p>
<blockquote>
<p>publish_notebook.py --file
  amp/oms/notebooks/Master_forecast_processor_reader.ipynb --action publish_on_s3
  --aws_profile saml-spm-sasm
  ```</p>
</blockquote>
<ul>
<li>You can also use a different path or profile by specifying it directly</li>
</ul>
<p>```bash</p>
<blockquote>
<p>publish_notebook.py \
  --file http://127.0.0.1:2908/notebooks/notebooks/Task40_Optimizer.ipynb \
  --action publish_on_s3 \
  --s3_path s3://alphamatic-data/notebooks \
  --aws_profile am
  ```</p>
</blockquote>
<h2 id="open-a-published-notebook">Open a published notebook</h2>
<h3 id="start-a-server">Start a server</h3>
<ul>
<li>
<p><code>(cd /local/home/share/html/published_notebooks; python3 -m http.server 8000)</code></p>
</li>
<li>
<p>go to the page in the local browser</p>
</li>
</ul>
<h3 id="using-the-dev-box">Using the dev box</h3>
<ul>
<li>To open a notebook saved on S3, *outside* a Docker container run:</li>
</ul>
<p>```bash</p>
<blockquote>
<p>publish_notebook.py --action open --file
  s3://alphamatic-data/notebooks/Task40_Optimizer.20210717_010806.html
  ```</p>
</blockquote>
<ul>
<li>This opens a Chrome window through X-windows.</li>
<li>To open files faster you can open a Chrome window in background with</li>
</ul>
<p>```bash</p>
<blockquote>
<p>google-chrome
  ```</p>
</blockquote>
<ul>
<li>and then navigate to the path (e.g.,
  <code>/local/home/share/html/published_notebooks/Master_forecast_processor_reader.20220810-112328.html</code>)</li>
</ul>
<h3 id="using-windows-browser">Using Windows browser</h3>
<ul>
<li>Another approach is:</li>
</ul>
<p>```bash</p>
<blockquote>
<p>aws s3 presign --expires-in 36000
  s3://alphamatic-data/notebooks/Task40_Optimizer.20210716_194400.html | xclip
  ```</p>
</blockquote>
<ul>
<li>Open the link saved in the clipboard in the Windows browser</li>
<li>For some reason, Chrome saves the link instead of opening, so you need to
  click on the saved link</li>
</ul>
<h1 id="how-to-create-a-private-fork">How to create a private fork</h1>
<ul>
<li>https://stackoverflow.com/questions/10065526/github-how-to-make-a-fork-of-public-repository-private</li>
<li>From
  https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/creating-a-repository-on-github/duplicating-a-repository</li>
</ul>
<p>```bash</p>
<blockquote>
<p>git clone --bare git@github.com:alphamatic/amp.git amp_bare</p>
<p>git push --mirror https://github.com/cryptomtc/cmamp.git
  ```</p>
</blockquote>
<ul>
<li>It worked only as cryptomtc, but not using my key</li>
</ul>
<h1 id="integrate-public-to-private-amp-cmamp">Integrate public to private: <code>amp</code> -&gt; <code>cmamp</code></h1>
<h2 id="set-up">Set-up</h2>
<pre><code class="language-bash">&gt; git remote add public git@github.com:alphamatic/amp

# Go to cmamp
&gt; cd /data/saggese/src/cmamp1
&gt; cd /Users/saggese/src/cmamp1

# Add the remote
# git remote add public https://github.com/exampleuser/public-repo.git
&gt; git remote add public git@github.com:alphamatic/amp

&gt; git remote -v
origin https://github.com/cryptomtc/cmamp.git (fetch)
origin https://github.com/cryptomtc/cmamp.git (push)
public git@github.com:alphamatic/amp (fetch)
public git@github.com:alphamatic/amp(push)
</code></pre>
<h2 id="ours-vs-theirs">Ours vs theirs</h2>
<ul>
<li>
<p>From
  https://stackoverflow.com/questions/25576415/what-is-the-precise-meaning-of-ours-and-theirs-in-git/25576672</p>
</li>
<li>
<p>When merging:</p>
</li>
<li>ours = branch checked out (git checkout *ours*)</li>
<li>theirs = branch being merged (git merge *theirs*)</li>
<li>When rebasing the role is swapped</li>
<li>ours = branch being rebased onto (e.g., master)</li>
<li>theirs = branch being rebased (e.g., feature)</li>
</ul>
<h2 id="sync-the-repos-after-double-integration">Sync the repos (after double integration)</h2>
<pre><code class="language-bash">&gt; git fetch origin; git fetch public

# Pull from both repos

&gt; git pull public master -X ours

# You might want to use `git pull -X theirs` or `ours`

&gt; git pull -X theirs

&gt; git pull public master -s recursive -X ours

# When there is a file added it is better to add

&gt; git diff --name-status --diff-filter=U | awk '{print $2}'

im/ccxt/db/test/test_ccxt_db_utils.py

# Merge branch

&gt; gs
+ git status
On branch AmpTask1786_Integrate_20211128_02 Your branch and 'origin/AmpTask1786_Integrate_20211128_02' have diverged, and have 861 and 489
different commits each, respectively. (use &quot;git pull&quot; to merge the remote branch into yours)

You are in a sparse checkout with 100% of tracked files present.

nothing to commit, working tree clean

&gt; git pull -X ours

## Make sure it's synced at ToT

&gt; rsync --delete -r /Users/saggese/src/cmamp2/ /Users/saggese/src/cmamp1
--exclude='.git/'

&gt; diff -r --brief /Users/saggese/src/cmamp1 /Users/saggese/src/cmamp2 | grep -v \.git
</code></pre>
<h2 id="updated-sync">Updated sync</h2>
<pre><code class="language-bash">&gt; git fetch origin; git fetch public
</code></pre>
<h2 id="check-that-things-are-fine">Check that things are fine</h2>
<pre><code class="language-bash">&gt; git diff origin/master... &gt;patch.txt

&gt; cd /Users/saggese/src/cmamp2

# Create a branch

&gt; git checkout -b Cmamp114_Integrate_amp_cmamp_20210928
&gt; git apply patch.txt

# Compare branch with references

&gt; dev_scripts/diff_to_vimdiff.py --dir1 /Users/saggese/src/cmamp1/im --dir2
/Users/saggese/src/cmamp2/im

&gt; diff -r --brief /Users/saggese/src/lemonade3/amp \~/src/cmamp2 | grep -v &quot;/im&quot;

# Creates a merge commit
&gt; git push origin master
</code></pre>
<h2 id="integrate-private-to-public-cmamp-amp">Integrate private to public: <code>cmamp</code> -&gt; <code>amp</code></h2>
<pre><code class="language-bash">&gt; cd /data/saggese/src/cmamp1
&gt; tar cvzf patch.tgz $(git diff --name-onlyorigin/master public/master | grep -v repo_config.py)

&gt; cd /Users/saggese/src/amp1 git remote add cmamp
&gt; git@github.com:cryptomtc/cmamp.git

&gt; GIT_SSH_COMMAND=&quot;ssh -i \~/.ssh/cryptomatic/id_rsa.cryptomtc.github&quot; git fetch
&gt; git@github.com:cryptomtc/cmamp.git

&gt; git checkout -b Integrate_20210928

&gt; GIT_SSH_COMMAND=&quot;ssh -i \~/.ssh/cryptomatic/id_rsa.cryptomtc.github&quot; git pull
&gt; cmamp master -X ours
</code></pre>
<h2 id="squash-commit-of-everything-in-the-branch">Squash commit of everything in the branch</h2>
<ul>
<li>From
  https://stackoverflow.com/questions/25356810/git-how-to-squash-all-commits-on-branch</li>
</ul>
<p>```bash</p>
<blockquote>
<p>git checkout yourBranch
git reset $(git merge-base master $(git branch
  --show-current))
git add -A
git commit -m "Squash"
git push --force
  ```</p>
</blockquote>
<h1 id="double-integration-cmamp-amp">Double integration <code>cmamp</code> &lt; -- &gt; <code>amp</code></h1>
<ul>
<li>The bug is https://github.com/alphamatic/amp/issues/1786</li>
</ul>
<h2 id="script-set-up">Script set-up</h2>
<pre><code class="language-bash">&gt; vi /Users/saggese/src/amp1/dev_scripts/integrate_repos/setup.sh
Update the date

&gt; vi /Users/saggese/src/amp1/dev_scripts/integrate_repos/*

&gt; cd \~/src/amp1
&gt; source /Users/saggese/src/amp1/dev_scripts/integrate_repos/setup.sh

&gt; cd \~/src/cmamp1
&gt; source /Users/saggese/src/amp1/dev_scripts/integrate_repos/setup.sh
</code></pre>
<h2 id="manual-set-up-branches">Manual set-up branches</h2>
<pre><code class="language-bash"># Go to cmamp1
&gt; go_amp.sh cmamp 1

# Set up the env vars in both clients
&gt; export AMP_DIR=/Users/saggese/src/amp1; export
CMAMP_DIR=/Users/saggese/src/cmamp1; echo &quot;$AMP_DIR&quot;; ls
$AMP_DIR; echo &quot;$CMAMP_DIR&quot;; ls $CMAMP_DIR

# Create two branches
&gt; export BRANCH_NAME=AmpTask1786_Integrate_20211010 export BRANCH_NAME=AmpTask1786_Integrate_2021117
...
&gt; cd $AMP_DIR

# Create automatically
&gt; i git_create_branch -b $BRANCH_NAME

# Create manually
&gt; git checkout -b $BRANCH_NAME
&gt; git push --set-upstream origin $BRANCH_NAME

&gt; cd $CMAMP_DIR
&gt; i git_create_branch -b $BRANCH_NAME
</code></pre>
<h2 id="high-level-plan">High-level plan</h2>
<ul>
<li>SUBDIR=im</li>
<li>Typically <code>cmamp</code> is copied on top of <code>amp</code></li>
<li>SUBDIR=devops</li>
<li><code>cmamp</code> and <code>amp</code> need to be different (until we unify the Docker flow)</li>
<li>Everything else</li>
<li>Typically <code>amp</code> -&gt; <code>cmamp</code></li>
</ul>
<h2 id="sync-im-cmamp-amp">Sync <code>im</code> <code>cmamp</code> -&gt; <code>amp</code></h2>
<pre><code class="language-bash">SUBDIR=im

# Check different files
&gt; diff -r --brief $AMP_DIR/$SUBDIR $CMAMP_DIR/$SUBDIR | grep -v .git

# Diff the entire dirs with vimdiff
&gt; dev_scripts/diff_to_vimdiff.py --dir1 $AMP_DIR/$SUBDIR --dir2 $CMAMP_DIR/$SUBDIR

# Find different files
&gt; find $AMP_DIR/$SUBDIR -name &quot;*&quot;; find $CMAMP_DIR/$SUBDIR -name &quot;*&quot; sdiff
/tmp/dir1 /tmp/dir2

# Copy cmamp -&gt; amp
&gt; rsync --delete -au $CMAMP_DIR/$SUBDIR/ $AMP_DIR/$SUBDIR
-a = archive
-u = ignore newer

# Add all the untracked files
&gt; cd $AMP_DIR/$SUBDIR &amp;&amp; git add $(git ls-files -o --exclude-standard)

# Check that there are no differences after copying
&gt; dev_scripts/diff_to_vimdiff.py --dir1 $AMP_DIR/$SUBDIR --dir2 $CMAMP_DIR/$SUBDIR

==========

&gt; rsync --delete -rtu $AMP_DIR/$SUBDIR/ $CMAMP_DIR/$SUBDIR

&gt; rsync --dry-run -rtui --delete $AMP_DIR/$SUBDIR/ $CMAMP_DIR/$SUBDIR/ .d..t.... ./
&gt; f..t.... __init__.py
cd+++++++ features/
&gt; f+++++++ features/__init__.py
&gt; f+++++++ features/pipeline.py
cd+++++++ features/test/
&gt; f+++++++ features/test/test_feature_pipeline.py
cd+++++++ features/test/TestFeaturePipeline.test1/
cd+++++++ features/test/TestFeaturePipeline.test1/output/
&gt; f+++++++ features/test/TestFeaturePipeline.test1/output/test.txt
.d..t.... price/
.d..t.... real_time/
&gt; f..t.... real_time/__init__.py
.d..t.... real_time/notebooks/
&gt; f..t.... real_time/notebooks/Implement_RT_interface.ipynb
&gt; f..t.... real_time/notebooks/Implement_RT_interface.py
.d..t.... real_time/test/
cd+++++++ real_time/test/TestRealTimeReturnPipeline1.test1/
cd+++++++ real_time/test/TestRealTimeReturnPipeline1.test1/output/
&gt; f+++++++ real_time/test/TestRealTimeReturnPipeline1.test1/output/test.txt
.d..t.... returns/
&gt; f..t.... returns/__init__.py
&gt; f..t.... returns/pipeline.py
.d..t.... returns/test/
&gt; f..t.... returns/test/test_returns_pipeline.py
.d..t.... returns/test/TestReturnsBuilder.test_equities1/
.d..t.... returns/test/TestReturnsBuilder.test_equities1/output/
.d..t.... returns/test/TestReturnsBuilder.test_futures1/
.d..t.... returns/test/TestReturnsBuilder.test_futures1/output/

&gt; rsync --dry-run -rtui --delete $CMAMP_DIR/$SUBDIR/ $AMP_DIR/$SUBDIR/
&gt; f..t.... price/__init__.py
&gt; f..t.... price/pipeline.py
&gt; f..t.... real_time/pipeline.py
&gt; f..t.... real_time/test/test_dataflow_amp_real_time_pipeline.py
&gt; f..t.... returns/test/TestReturnsBuilder.test_equities1/output/test.txt
&gt; f..t.... returns/test/TestReturnsBuilder.test_futures1/output/test.txt
</code></pre>
<h2 id="sync-everything">Sync everything</h2>
<pre><code class="language-bash"># Check if there is anything in cmamp more recent than amp
&gt; rsync -au --exclude='.git' --exclude='devops' $CMAMP_DIR/ $AMP_DIR

# vimdiff
&gt; dev_scripts/diff_to_vimdiff.py --dir1 $AMP_DIR --dir2
$CMAMP_DIR

F1: skip
F9: choose left (i.e., amp)
F10: choose right (i.e,. cmamp)

# Copy

&gt; rsync -au --delete --exclude='.git' --exclude='devops' --exclude='im'
$AMP_DIR/
$CMAMP_DIR

# Add all the untracked files

&gt; (cd $CMAMP_DIR/$SUBDIR &amp;&amp; git add $(git ls-files -o --exclude-standard))

&gt; diff -r --brief $AMP_DIR $CMAMP_DIR | grep -v .git | grep Only
</code></pre>
<h2 id="files-that-need-to-be-different">Files that need to be different</h2>
<ul>
<li>
<p><code>amp</code> needs an <code>if False</code> <code>helpers/lib_tasks.py</code></p>
</li>
<li>
<p><code>amp</code> needs two tests disabled <code>im/ccxt/data/load/test/test_loader.py</code></p>
</li>
</ul>
<p><code>im/ccxt/data/load/test/test_loader.py</code></p>
<p>TODO(gp): How to copy files in vimdiff including last line?</p>
<ul>
<li>Have a script to remove all the last lines</li>
<li>Some files end with an <code>0x0a</code></li>
<li>tr -d '\r'</li>
</ul>
<p>```bash</p>
<blockquote>
<p>find . -name "*.txt" | xargs perl -pi -e 's/\r\n/\n/g'
  # Remove <code>No newline at end of file</code>
find . -name "*.txt" | xargs perl -pi -e 'chomp if eof'
  ```</p>
</blockquote>
<h3 id="lint-everything">Lint everything</h3>
<pre><code class="language-bash">&gt; autoflake amp_check_filename amp_isort amp_flake8 amp_class_method_order
amp_normalize_import amp_format_separating_line amp_black

&gt; i lint --phases=&quot;amp_isort amp_class_method_order amp_normalize_import
amp_format_separating_line amp_black&quot; --files='$(find . -name &quot;\*.py&quot;)'
</code></pre>
<h3 id="testing">Testing</h3>
<ul>
<li>Run <code>amp</code> on my laptop (or on the server)</li>
<li>IN PROGRESS: Get <code>amp</code> PR to pass on GH</li>
<li>IN PROGRESS: Run lemonade on my laptop</li>
<li>Run <code>cmamp</code> on the dev server</li>
<li>Get <code>cmamp</code> PR to pass on GH</li>
<li>Run dev_tools on the dev server</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
